<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAND-BY-ME 3D | Vibrant Night Market</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root { 
            --neon-pink: #ff00ff; --neon-blue: #00ffff; --neon-yellow: #ffff00; --neon-green: #39ff14; 
        }
        body { background: #110011; color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* Arcade Frame */
        .arcade-cabinet { 
            background: #2a2a2a; padding: 12px; border: 6px solid #444; border-radius: 20px; 
            box-shadow: 0 0 40px rgba(255, 0, 255, 0.2), inset 0 0 20px #000;
        }
        
        .main-layout { display: flex; gap: 10px; background: #000; padding: 5px; border-radius: 10px; }
        
        .canvas-area { position: relative; width: 800px; height: 500px; border: 2px solid #333; overflow: hidden; }
        
        /* Sidebar Styling */
        .sidebar { width: 180px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(180deg, #1a1a1a 0%, #000 100%); }
        .label { font-size: 0.65rem; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 2px; font-weight: bold; }
        .digital { font-family: 'Courier New', monospace; font-size: 1.5rem; color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); margin-bottom: 15px; }
        
        /* Progress Bar */
        .timer-wrap { width: 100%; height: 12px; background: #222; border: 1px solid #444; margin: 5px 0 20px 0; border-radius: 6px; overflow: hidden; }
        #timerFill { width: 100%; height: 100%; background: linear-gradient(90deg, var(--neon-pink), var(--neon-yellow)); box-shadow: 0 0 10px var(--neon-pink); }
        
        /* Overlays */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; }
        .hidden { display: none !important; }
        .btn { background: var(--neon-pink); color: white; border: none; padding: 15px 40px; font-weight: 900; cursor: pointer; clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%); transition: 0.2s; }
        .btn:hover { background: var(--neon-blue); transform: scale(1.1); }
    </style>
</head>
<body>

<div class="arcade-cabinet">
    <div class="main-layout">
        <div class="canvas-area">
            <canvas id="gameCanvas"></canvas>
            
            <div id="ui-start" class="overlay">
                <h1 style="font-size: 3rem; margin:0; text-shadow: 0 0 20px var(--neon-pink);">STAND-BY-ME</h1>
                <p style="color: var(--neon-blue);">STALL #07 - BEVERAGE CHALLENGE</p>
                <button class="btn" onclick="startGame()">START SESSION</button>
            </div>

            <div id="ui-over" class="overlay hidden">
                <h1 style="color: var(--neon-pink);">SESSION ENDED</h1>
                <p id="death-msg"></p>
                <button class="btn" onclick="location.reload()">RETRY</button>
            </div>
        </div>

        <div class="sidebar">
            <div>
                <div class="label">Time Limit</div>
                <div class="timer-wrap"><div id="timerFill"></div></div>
                
                <div class="label">Total Score</div>
                <div id="score" class="digital">0000</div>
                
                <div class="label">Current Stall</div>
                <div id="level" class="digital" style="color:var(--neon-blue)">01</div>
            </div>
            <div>
                <div class="label">Stamina</div>
                <div id="lives" style="font-size: 1.2rem; margin-top: 5px;">❤️❤️❤️</div>
            </div>
        </div>
    </div>
</div>

<script>
// --- THREE.JS SCENE SETUP ---
const canvas = document.getElementById("gameCanvas");
let scene, camera, renderer, bottle, ring, rope, ground;
let lanterns = [];

const state = {
    active: false, over: false, win: false,
    level: 1, score: 0, lives: 3,
    bX: 400, bAngle: 0, bVel: 0,
    rX: 400, rY: 150, rVX: 0, rVY: 0,
    mX: 400, mY: 50,
    hooked: false, dragging: false,
    time: 20, maxTime: 20,
    palette: ["#ff00ff", "#39ff14", "#00ffff"] // Pink, Green, Blue
};

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x110011);
    scene.fog = new THREE.Fog(0x110011, 200, 1000);

    camera = new THREE.PerspectiveCamera(45, 800 / 500, 1, 2000);
    camera.position.set(0, 80, 500);

    renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(800, 500);

    // 1. VIBRANT LIGHTING
    const pinkLight = new THREE.PointLight(0xff00ff, 2, 600);
    pinkLight.position.set(-200, 200, 100);
    scene.add(pinkLight);

    const blueLight = new THREE.PointLight(0x00ffff, 2, 600);
    blueLight.position.set(200, 200, 100);
    scene.add(blueLight);

    // 2. REFLECTIVE MARKET FLOOR
    const floorGeo = new THREE.PlaneGeometry(2000, 2000);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.1, metalness: 0.5 });
    ground = new THREE.Mesh(floorGeo, floorMat);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = -150;
    scene.add(ground);

    // 3. STALL DECORATIONS (Canopy & Signs)
    const canopyGeo = new THREE.BoxGeometry(700, 10, 300);
    const canopyMat = new THREE.MeshStandardMaterial({ color: 0xff0055 });
    const canopy = new THREE.Mesh(canopyGeo, canopyMat);
    canopy.position.set(0, 300, -100);
    scene.add(canopy);

    // 4. THE TABLE
    const tableGeo = new THREE.BoxGeometry(600, 20, 250);
    const tableMat = new THREE.MeshStandardMaterial({ color: 0x222222 });
    const table = new THREE.Mesh(tableGeo, tableMat);
    table.position.y = -90;
    scene.add(table);

    // 5. THE BOTTLE
    bottle = new THREE.Group();
    const body = new THREE.Mesh(
        new THREE.CylinderGeometry(20, 24, 130, 32),
        new THREE.MeshPhysicalMaterial({ color: 0x00ff88, transmission: 0.4, transparent: true, thickness: 2 })
    );
    body.rotation.z = Math.PI / 2;
    body.position.x = 65; // Pivot logic
    bottle.add(body);
    
    const cap = new THREE.Mesh(new THREE.CylinderGeometry(10, 10, 20), new THREE.MeshBasicMaterial({ color: 0xff0000 }));
    cap.rotation.z = Math.PI / 2; cap.position.x = 145;
    bottle.add(cap);
    scene.add(bottle);

    // 6. THE RING & ROPE
    ring = new THREE.Mesh(new THREE.TorusGeometry(22, 3, 16, 50), new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff }));
    scene.add(ring);
    rope = new THREE.Line(new THREE.BufferGeometry(), new THREE.LineBasicMaterial({ color: 0xffffff }));
    scene.add(rope);

    // 7. LANTERNS (Vibrant Orbs)
    for(let i=0; i<6; i++) {
        const color = i % 2 === 0 ? 0xff00ff : 0xffff00;
        const lan = new THREE.Mesh(new THREE.SphereGeometry(12, 16, 16), new THREE.MeshBasicMaterial({ color }));
        lan.position.set(-400 + (i*160), 250, -150);
        scene.add(lan);
        lanterns.push(lan);
        const l = new THREE.PointLight(color, 1, 200);
        l.position.copy(lan.position);
        scene.add(l);
    }
}

// --- GAME LOGIC ---
function update() {
    if (!state.active || state.over) return;

    // Timer
    state.time -= 0.016;
    document.getElementById("timerFill").style.width = (state.time / state.maxTime * 100) + "%";
    if (state.time <= 0) die("TIME EXPIRED");

    // Ring Physics
    state.rVX += (state.mX - state.rX) * 0.05;
    state.rVY += (state.mY - state.rY) * 0.05 + 0.8;
    state.rX += state.rVX; state.rY += state.rVY;
    state.rVX *= 0.92; state.rVY *= 0.92;

    const cX = state.bX + Math.cos(state.bAngle) * 170;
    const cY = 350 + Math.sin(state.bAngle) * 170;

    if (state.hooked) {
        if (Math.hypot(state.rX - cX, state.rY - cY) > 95) {
            state.hooked = false;
        } else {
            // FIXED ROTATION (Tilts towards cursor)
            const target = Math.atan2(state.rY - 350, state.rX - state.bX);
            state.bAngle += (target - state.bAngle) * 0.15;
            state.bVel += (state.rX - cX) * 0.05;
        }
    } else {
        if (state.bAngle < 0) state.bAngle += (0.06 + state.level * 0.005);
        if (state.bAngle < -0.8) die("BOTTLE TOPPLED");
        if (state.bAngle > 0) state.bAngle = 0;
        state.bVel += (400 - state.bX) * 0.04;
    }

    state.bX += state.bVel;
    state.bVel *= 0.95;

    if (state.bX < 110 || state.bX > 690) die("OFF THE TABLE");

    // Win Check
    if (state.bAngle <= -1.48 && Math.abs(state.bVel) < 0.2) {
        state.score += 100;
        state.level++;
        document.getElementById("score").innerText = state.score.toString().padStart(4, '0');
        document.getElementById("level").innerText = state.level.toString().padStart(2, '0');
        reset();
    }
}

function render() {
    bottle.position.set(state.bX - 400, -80, 0);
    bottle.rotation.z = state.bAngle; // Corrected mapping
    
    ring.position.set(state.rX - 400, -(state.rY - 250), 0);
    ring.material.emissiveIntensity = state.hooked ? 5 : 0.5;

    const curve = new THREE.QuadraticBezierCurve3(
        new THREE.Vector3(0, 250, 0),
        new THREE.Vector3(0, 150, 0),
        ring.position.clone()
    );
    rope.geometry.setFromPoints(curve.getPoints(20));

    lanterns.forEach((l, i) => l.position.y = 250 + Math.sin(Date.now()*0.002 + i)*10);
    
    renderer.render(scene, camera);
}

function die(msg) {
    state.lives--;
    document.getElementById("lives").innerText = "❤️".repeat(state.lives);
    if (state.lives <= 0) {
        state.over = true;
        document.getElementById("ui-over").classList.remove("hidden");
        document.getElementById("death-msg").innerText = msg;
    } else {
        reset();
    }
}

function reset() {
    state.bX = 400; state.bAngle = 0; state.bVel = 0;
    state.rX = 400; state.rY = 150; state.hooked = false;
    state.time = state.maxTime;
}

function startGame() {
    state.active = true;
    document.getElementById("ui-start").classList.add("hidden");
}

// Input Handlers
canvas.addEventListener('mousedown', e => {
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX - r.left) * (800 / r.width);
    const y = (e.clientY - r.top) * (500 / r.height);
    if (Math.hypot(x - state.rX, y - state.rY) < 60) state.dragging = true;
});
window.addEventListener('mousemove', e => {
    const r = canvas.getBoundingClientRect();
    state.mX = (e.clientX - r.left) * (800 / r.width);
    state.mY = (e.clientY - r.top) * (500 / r.height);
    if (state.dragging && !state.hooked) {
        const cX = state.bX + Math.cos(state.bAngle) * 170;
        const cY = 350 + Math.sin(state.bAngle) * 170;
        if (Math.hypot(state.rX - cX, state.rY - cY) < 30) state.hooked = true;
    }
});
window.addEventListener('mouseup', () => state.dragging = false);

window.onload = () => {
    init();
    function loop() { update(); render(); requestAnimationFrame(loop); }
    loop();
};
</script>
</body>
</html>
